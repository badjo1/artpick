<div class="continuum-container">
  <div class="admin-header">
    <h1>Bulk Upload Artworks - <%= @exhibition.title %></h1>
    <%= link_to "Back", admin_exhibition_artworks_path(@exhibition), class: "btn btn-secondary" %>
  </div>

  <div class="bulk-upload-container">
    <h3>Upload multiple artworks at once</h3>
    <p class="form-help">Drag images to the area below or click to select. You can select multiple images at once.</p>

    <%= form_with url: bulk_create_admin_exhibition_artworks_path(@exhibition), multipart: true, id: "bulk-upload-form" do |f| %>
      <div class="form-group">
        <%= f.label :artist_id, "Artist (optional - applies to all uploads)" %>
        <%= f.select :artist_id,
            options_from_collection_for_select(@artists, :id, :name),
            { include_blank: "No artist" },
            class: "form-input" %>
      </div>

      <div class="form-group">
        <%= f.label :screen_id, "Screen (optional - applies to all uploads)" %>
        <%= f.select :screen_id,
            options_from_collection_for_select(@screens, :id, :name),
            { include_blank: "No screen (show individually)" },
            class: "form-input" %>
      </div>

      <div class="file-drop-zone" id="dropZone">
        <p style="margin: 0; font-size: 1.125rem; font-weight: 500;">
          ðŸ“¸ Drag images here
        </p>
        <p style="margin: 0.5rem 0 0; color: var(--color-text-secondary); font-size: 0.875rem;">
          or click to select
        </p>
        <%= f.file_field :files,
            multiple: true,
            accept: "image/jpeg,image/png,image/gif,image/webp,video/mp4",
            style: "display: none;",
            id: "fileInput",
            onchange: "handleFiles(this.files)" %>
      </div>

      <div id="filePreviewContainer" style="display: none;">
        <h4 style="margin-top: 2rem; margin-bottom: 1rem;">Selected images (<span id="fileCount">0</span>)</h4>
        <div class="file-preview-grid" id="filePreviewGrid"></div>
      </div>

      <div class="form-actions" id="uploadActions" style="display: none; margin-top: 2rem;">
        <%= f.submit "Upload all artworks", class: "btn btn-primary", id: "submitBtn" %>
        <button type="button" class="btn btn-secondary" onclick="clearFiles()">Clear</button>
      </div>
    <% end %>
  </div>
</div>

<script>
let selectedFiles = [];

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const filePreviewContainer = document.getElementById('filePreviewContainer');
const filePreviewGrid = document.getElementById('filePreviewGrid');
const uploadActions = document.getElementById('uploadActions');
const fileCount = document.getElementById('fileCount');

// Click to select files
dropZone.addEventListener('click', () => {
  fileInput.click();
});

// Drag and drop handlers
dropZone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropZone.classList.add('dragging');
});

dropZone.addEventListener('dragleave', () => {
  dropZone.classList.remove('dragging');
});

dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  dropZone.classList.remove('dragging');
  handleFiles(e.dataTransfer.files);
});

function handleFiles(files) {
  selectedFiles = Array.from(files);
  updatePreview();
}

function updatePreview() {
  filePreviewGrid.innerHTML = '';

  if (selectedFiles.length === 0) {
    filePreviewContainer.style.display = 'none';
    uploadActions.style.display = 'none';
    return;
  }

  filePreviewContainer.style.display = 'block';
  uploadActions.style.display = 'flex';
  fileCount.textContent = selectedFiles.length;

  selectedFiles.forEach((file, index) => {
    const div = document.createElement('div');
    div.className = 'file-preview-item';

    if (file.type.startsWith('video')) {
      const video = document.createElement('video');
      video.src = URL.createObjectURL(file);
      video.controls = true;
      video.preload = 'metadata';
      video.style.maxWidth = '100%';
      div.innerHTML = `
        <p class="file-name">${file.name}</p>
        <button type="button" class="file-preview-remove" onclick="removeFile(${index})" title="Remove">Ã—</button>
      `;
      div.prepend(video);
      filePreviewGrid.appendChild(div);
    } else {
      const reader = new FileReader();
      reader.onload = (e) => {
        div.innerHTML = `
          <img src="${e.target.result}" alt="${file.name}">
          <p class="file-name">${file.name}</p>
          <button type="button" class="file-preview-remove" onclick="removeFile(${index})" title="Remove">Ã—</button>
        `;
        filePreviewGrid.appendChild(div);
      };
      reader.readAsDataURL(file);
    }
  });

  // Update the file input with selected files
  const dataTransfer = new DataTransfer();
  selectedFiles.forEach(file => dataTransfer.items.add(file));
  fileInput.files = dataTransfer.files;
}

function removeFile(index) {
  selectedFiles.splice(index, 1);
  updatePreview();
}

function clearFiles() {
  selectedFiles = [];
  updatePreview();
}

// Show upload progress
document.getElementById('bulk-upload-form').addEventListener('submit', function() {
  document.getElementById('submitBtn').disabled = true;
  document.getElementById('submitBtn').textContent = `Uploading ${selectedFiles.length} artworks...`;
});
</script>
